pico-8 cartridge // http://www.pico-8.com
version 36
__lua__
--
-- picochat.p8
-- (c) 2022, joshua moore
--
-- p8modem internet chat client
-- for the pico-8
--
-- this program is free software
-- licensed under the terms of
-- the gnu gplv3.
-- see license.txt for details.
--

#include p8modem.lua


function _init()
  -- enable keyboard
  poke(0x5f2d, 0x1)

  -- user message input string
  usrinput = ""
  iptchanged = true

  -- user's name
  username = nil

  -- received chat messages
  msgs = { }
  msgrecvd = true

  cls()
  print("\n\nwelcome to picochat!\n", 11)
  print("  enter a nickname", 12)
  print("  max 8 chars\n")
  print("  tab to submit nickname")
  print("  tab to send messages in chat\n")
  print("â™¥ be nice! â™¥", 11)
end


function _update()
  -- receive messages
  pkt = p8m_recv()
  if pkt != nil then
    add(msgs, pkt_tostr(pkt))
    while #msgs > 9 do
      deli(msgs, 1)
    end
    msgrecvd = true
  end

  if username then
    input(30)
  else
    input(8)
  end
end


function _draw()
  if username then
    render_chat()
  else
    render_login()
  end
end


-- prompt the user for a name
function render_login()
  render_input(13)
end


-- display incoming messages,
-- and prompt the user to send
-- their own messages
function render_chat()
  if msgrecvd then
    -- print blank lines
    rectfill(0, 0, 127, 19 * 6 - 1, 0)

    -- print chat lines
    blanks = 9 - #msgs
    cursor(0, 6 * blanks * 2)
    for i = 1, #msgs do
      print(msgs[i], 7)
    end

    msgrecvd = false
  end

  -- display prompt
  render_input(19)
end

function render_input(linenum)
  if iptchanged then
    ostr = ">>" .. usrinput
    spaces = 30 - #usrinput
    for i = spaces, 1, -1 do
      ostr = ostr .. " "
    end

    rectfill(0, 6 * linenum, 127, 6 * linenum + 6, 0)
    print(ostr, 0, 6 * linenum, 12)

    iptchanged = false
  end
end


-- utils --

-- convert received messages
-- from arrays to strings
function pkt_tostr(pkt)
  msg = ""
  for i = 1, #pkt do
    msg = msg .. chr(pkt[i])
  end
  return msg
end


-- non-blocking key reader
-- return keycode if a key
-- is pressed
-- return nil if no keypress
function getch()
  if stat(30) then
    return ord(stat(31))
  else
    return nil
  end
end


-- build chat input str from
-- user keypresses
function input(maxc)
  key = getch()
  if key then
    if key == 8 then
      -- backspace
      usrinput = sub(usrinput, 1, -2)
    elseif key == 9 then
      -- send message
      if username == nil then
        username = usrinput
      end

      p8m_send(usrinput)
      usrinput = ""
    elseif #usrinput < maxc then
      usrinput = usrinput .. chr(key)
    end
    iptchanged = true
  end
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
b0b0bbb0b0000bb00bb0bbb0bbb00000bbb00bb00000bbb0bbb00bb00bb00bb0b0b0bbb0bbb00b00000000000000000000000000000000000000000000000000
b0b0b000b000b000b0b0bbb0b00000000b00b0b00000b0b00b00b000b0b0b000b0b0b0b00b000b00000000000000000000000000000000000000000000000000
b0b0bb00b000b000b0b0b0b0bb0000000b00b0b00000bbb00b00b000b0b0b000bbb0bbb00b000b00000000000000000000000000000000000000000000000000
bbb0b000b000b000b0b0b0b0b00000000b00b0b00000b0000b00b000b0b0b000b0b0b0b00b000000000000000000000000000000000000000000000000000000
bbb0bbb0bbb00bb0bb00b0b0bbb000000b00bb000000b000bbb00bb0bb000bb0b0b0b0b00b000b00000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ccc0cc00ccc0ccc0ccc00000ccc00000cc00ccc00cc0c0c0cc00ccc0ccc0ccc000000000000000000000000000000000000000000000000000000000
00000000c000c0c00c00c000c0c00000c0c00000c0c00c00c000c0c0c0c0c0c0ccc0c00000000000000000000000000000000000000000000000000000000000
00000000cc00c0c00c00cc00cc000000ccc00000c0c00c00c000cc00c0c0ccc0c0c0cc0000000000000000000000000000000000000000000000000000000000
00000000c000c0c00c00c000c0c00000c0c00000c0c00c00c000c0c0c0c0c0c0c0c0c00000000000000000000000000000000000000000000000000000000000
00000000ccc0c0c00c00ccc0c0c00000c0c00000c0c0ccc00cc0c0c0c0c0c0c0c0c0ccc000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ccc0ccc0c0c00000ccc000000cc0c0c0ccc0ccc00cc00000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ccc0c0c0c0c00000c0c00000c000c0c0c0c0c0c0c0000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000c0c0ccc00c000000ccc00000c000ccc0ccc0cc00ccc00000000000000000000000000000000000000000000000000000000000000000000000000000
00000000c0c0c0c0c0c00000c0c00000c000c0c0c0c0c0c000c00000000000000000000000000000000000000000000000000000000000000000000000000000
00000000c0c0c0c0c0c00000ccc000000cc0c0c0c0c0c0c0cc000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ccc0ccc0ccc00000ccc00cc000000cc0c0c0ccc0ccc0ccc0ccc00000cc00ccc00cc0c0c0cc00ccc0ccc0ccc000000000000000000000000000000000
000000000c00c0c0c0c000000c00c0c00000c000c0c0c0c0ccc00c000c000000c0c00c00c000c0c0c0c0c0c0ccc0c00000000000000000000000000000000000
000000000c00ccc0cc0000000c00c0c00000ccc0c0c0cc00c0c00c000c000000c0c00c00c000cc00c0c0ccc0c0c0cc0000000000000000000000000000000000
000000000c00c0c0c0c000000c00c0c0000000c0c0c0c0c0c0c00c000c000000c0c00c00c000c0c0c0c0c0c0c0c0c00000000000000000000000000000000000
000000000c00c0c0ccc000000c00cc000000cc000cc0ccc0c0c0ccc00c000000c0c0ccc00cc0c0c0c0c0c0c0c0c0ccc000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ccc0ccc0ccc00000ccc00cc000000cc0ccc0cc00cc000000ccc0ccc00cc00cc0ccc00cc0ccc00cc00000ccc0cc0000000cc0c0c0ccc0ccc000000000
000000000c00c0c0c0c000000c00c0c00000c000c000c0c0c0c00000ccc0c000c000c000c0c0c000c000c00000000c00c0c00000c000c0c0c0c00c0000000000
000000000c00ccc0cc0000000c00c0c00000ccc0cc00c0c0c0c00000c0c0cc00ccc0ccc0ccc0c000cc00ccc000000c00c0c00000c000ccc0ccc00c0000000000
000000000c00c0c0c0c000000c00c0c0000000c0c000c0c0c0c00000c0c0c00000c000c0c0c0c0c0c00000c000000c00c0c00000c000c0c0c0c00c0000000000
000000000c00c0c0ccc000000c00cc000000cc00ccc0c0c0ccc00000c0c0ccc0cc00cc00c0c0ccc0ccc0cc000000ccc0c0c000000cc0c0c0c0c00c0000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bb0bb000000bbb0bbb00000bb00bbb00bb0bbb00b0000000bb0bb00000000000000000000000000000000000000000000000000000000000000000000000000
0bbbbb000000b0b0b0000000b0b00b00b000b0000b0000000bbbbb00000000000000000000000000000000000000000000000000000000000000000000000000
0bbbbb000000bb00bb000000b0b00b00b000bb000b0000000bbbbb00000000000000000000000000000000000000000000000000000000000000000000000000
00bbb0000000b0b0b0000000b0b00b00b000b0000000000000bbb000000000000000000000000000000000000000000000000000000000000000000000000000
000b00000000bbb0bbb00000b0b0bbb00bb0bbb00b000000000b0000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00c000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

